<!DOCTYPE html>
<html lang="zh-CN" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="xesam" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  
  
  <title>
    
      如何写一个JsBridge 
      
      
      |
    
     XiaoPingYuan
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <!-- <a href="/">
      
        <img src="/images/avatar.png" alt="">
      
    </a> -->
    <div class="nickname"><a href="/">Just Do IT</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">如何写一个JsBridge</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <!-- <i class="iconfont icon-updatetime mr-10" title="更新时间"></i> -->
          <!-- 2025-04-16 16:32:33 -->
          <i class="iconfont icon-updatetime mr-10"></i>
          2016-04-12 00:00:00
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="分类"></i>
                
                <span class="span--category">
                  <a href="/categories/android/" title="android">
                    <b>#</b> android
                  </a>
                </span>
                
              </span>
          
              <span class="post-tags">
                <i class="iconfont icon-tags mr-10" title="标签"></i>
                
                <span class="span--tag mr-8">
                  <a href="/tags/android/" title="android">
                    #android
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <p>Android JsBridge 就是用来在 Android app的原生 java 代码与 javascript 代码中架设通信（调用）桥梁的辅助工具。 </p>
<p><a href="http://xesam.github.io/android/2016/04/11/Android-how-to-JsBridge.html">原文地址点这里</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xesam/JsBridge">github点这里</a></p>
<p><a href="#anchor_usage">使用方式戳这里</a></p>
<p>有问题请联系 <a href="http://xesam.github.io/about/">xesam</a></p>
<p>或者 QQ 群 315658668</p>
<h2 id="原理概述"><a href="#原理概述" class="headerlink" title="原理概述"></a>原理概述</h2><p>Javascript 运行在 WebView 中，而 WebView 只是 Javascript 执行引擎与页面渲染引擎的一个包装而已。</p>
<p>由于这种天然的隔离效应，我们可以将这种情况与 IPC 进行类比，将 Java 与 Javascript 的每次互调都看做一次 IPC 调用。<br>如此一来，我们可以模仿各种已有的 IPC 方式来进行设计，比如 RPC。本文模仿 RPC 机制来实现一个 JsBridge。</p>
<p>首先回顾一一下基于 Binder 的经典 RPC 调用：</p>
<p><img src="http://xesam.github.io/image/js-bridge-rpc.png" alt="Javascript-bridge-rpc"></p>
<p>当然，client 与 server 只是用来区分通信双方责任的叫法而已，并不是一成不变的。<br>对于 java 与 javascript 互调的情况，当 java 主动调用 javascript 的时候，java 充当 client 角色，javascript 则扮演 server 的角色，<br>javascript 中的函数执行完毕后回调 java 方法，这个时候，javascript 充当 client 角色，而 java 则承担 server 的责任。</p>
<p><img src="http://xesam.github.io/image/js-bridge-circle.png" alt="Javascript-bridge-circle"></p>
<p>剩下的问题就是怎么来实现这个机制了，大致有这么几个需要解决的问题：</p>
<ol>
<li>java 如何调用 Javascript</li>
<li>Javascript 如何调用 java</li>
<li>方法参数以及回调如何处理</li>
<li>通信的数据格式是怎样的</li>
</ol>
<p>下面逐个讨论这些问题：</p>
<h2 id="1-java-如何调用-Javascript"><a href="#1-java-如何调用-Javascript" class="headerlink" title="1. java 如何调用 Javascript"></a>1. java 如何调用 Javascript</h2><p>要实现 Java 与 Javascript 的相互调用，有两条途径可以考虑：</p>
<ol>
<li>集成一个定制化的 Javascript 与 Html 渲染引擎，java 通过引擎底层与 Javascript 交互。这样可以获得完全的控制权。</li>
<li>使用 Android Sdk 提供的交互方法。</li>
</ol>
<p>对于第一种途径，代价比较大，而且技术方案比较复杂，一般只有基于 Javascript 的跨平台开发方案才会这么做。<br>所以，现在着重考查第二种途径。</p>
<p>Android 的默认 Sdk 中， Java 与 Javascript 的一切交互都是依托于 WebView 的，大致有以下几个可用方法：</p>
<p>第一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">webView.loadUrl(<span class="string">&quot;javascript:scriptString&quot;</span>); <span class="comment">//其中 scriptString 为 Javascript 代码</span></span><br></pre></td></tr></table></figure>
<p>第二，在 KITKAT 之后，又新增了一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">webView.evaluateJavascript(scriptString, <span class="keyword">new</span> <span class="title class_">ValueCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveValue</span><span class="params">(String value)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);<span class="comment">//其中 scriptString 为 Javascript 代码，ValueCallback 的用来获取 Javascript 的执行结果。这是一个异步掉用。</span></span><br></pre></td></tr></table></figure>

<p>这个调用看起比上面的正常，而且更像是一个方法调用。</p>
<p><s>需要注意的是，ValueCallback 并不是在 UI 线程里面执行的。</s><br>修正：evaluateJavascript 和 ValueCallback 都是在 UI 线程调用和触发的，<br>文档参见 [<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/webkit/WebView.html#evaluateJavascript]">https://developer.android.google.cn/reference/android/webkit/WebView.html#evaluateJavascript]</a>(<a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/android/webkit/WebView.html#evaluateJavascript">https://developer.android.google.cn/reference/android/webkit/WebView.html#evaluateJavascript</a>(java.lang.String, android.webkit.ValueCallback&lt;java.lang.String&gt;))<br>感谢 “jordan大师兄” 的指正。</p>
<h2 id="2-Javascript-如何调用-java"><a href="#2-Javascript-如何调用-java" class="headerlink" title="2. Javascript 如何调用 java"></a>2. Javascript 如何调用 java</h2><p>要实现 Javascript 调用 java 方法，需要先在 Javascript 环境中注入一个 Java 代理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JavaProxy</span>&#123;</span><br><span class="line">    <span class="meta">@JavascriptInterface</span> <span class="comment">//注意这里的注解。出于安全的考虑，4.2 之后强制要求，不然无法从 Javascript 中发起调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">javaFn</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//xxxxxx</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">JavaProxy</span>();, <span class="string">&quot;java_proxy&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>然后在 Javascript 环境中直接调用 obj_proxy 代理上的方法即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">java_proxy.<span class="title function_">javaFn</span>();</span><br></pre></td></tr></table></figure>

<p>这里有两个方面需要统一：</p>
<ol>
<li>Javascript 的执行方法比较怪异，所以，我们需要将概念统一化。</li>
<li>如果需要执行的方法比较多，那么，代理对象上也需要定义非常多的方法，我们需要将各种方法定义统一起来管理。</li>
</ol>
<p>所以，我们先将 Javascript 的执行包装成类似 java 一样的代理对象，然后通过在各自的 stub 上注册回调来增加功能支持。<br>比如，如果 java 想增加 getPackageName 方法，那么，直接在 JavaProxy 上注册即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">javaProxy.register(<span class="string">&quot;getPackageName&quot;</span>, <span class="keyword">new</span> <span class="title class_">JavaHandler</span>()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Object value)</span>&#123;</span><br><span class="line">        <span class="comment">//xxxxx</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如图：</p>
<p><img src="http://xesam.github.io/image/js-bridge-register.png" alt="Javascript-bridge-register"></p>
<h2 id="3-方法参数以及回调如何处理"><a href="#3-方法参数以及回调如何处理" class="headerlink" title="3. 方法参数以及回调如何处理"></a>3. 方法参数以及回调如何处理</h2><p>很显然，任何 IPC 通信都涉及到参数序列化的问题， 同理 java 与 Javascript 之间只能传递基础类型（注意，不单纯是基本类型），包括基本类型与字符串，不包括其他对象或者函数。<br>由于只涉及到简单的相互调用，这里就可以考虑采用 JSON 格式来传递各种数据，轻量而简洁。</p>
<p>Java 调用 Javascript 没有返回值（这里指 loadUrl 形式的调用），因此如果 java 端想从 Javascript 中获取返回值，只能使用回调的形式。<br>但是在执行完毕之后如何找到正确的回调方法信息，这是一个重要的问题。比如有下面的例子：</p>
<p>在 java 环境中，JavaProxy 对象有一个无参数的 getPackageName 方法用来获取当前应用的 PackageName。<br>获取到 packageName 之后，传递给 Javascript 调用者的对应回调中。</p>
<p>在 Javascript 环境中，获取当前应用的 PackageName 的大致调用如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bridge.<span class="title function_">invoke</span>(<span class="string">&#x27;getPackageName&#x27;</span>, <span class="literal">null</span>, <span class="keyword">function</span>(<span class="params">packageName</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(packageName);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>显然</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>(<span class="params">packageName</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(packageName);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>这个 Javascript 函数是无法传递到 java 环境中的，所以，可以采取的一个策略就是，<br>在 Javascript 环境中将所有回调统一管理起来，而只是将回调的 id 传递到 java 环境去，java 方法执行完毕之后，<br>将回调参数以及对应的回调 id 返回给 Javascript 环境，由 Javascript 来负责执行正确的回调。</p>
<p>这样，我们就可以实现一个简单的回调机制：</p>
<p>在 java 环境中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JavaProxy</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTransact</span><span class="params">(String jsonInvoke, String jsonParam)</span>&#123;</span><br><span class="line">        json = <span class="keyword">new</span> <span class="title class_">Json</span>(jsonInvoke);</span><br><span class="line">        invokeName = json.getInvokeName(); <span class="comment">// getPackageName</span></span><br><span class="line">        callbackId = json.getCallbackId(); <span class="comment">// 12345678xx</span></span><br><span class="line">        invokeParam = <span class="keyword">new</span> <span class="title class_">Param</span>(jsonParam);<span class="comment">// null</span></span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        JsProxy.invoke(callbackId, callbackParam); <span class="comment">//发起 Javascript 调用，让 Javascript 去执行对应的回调</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 javascript 环境中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">bridge.<span class="property">invoke</span> = <span class="keyword">function</span>(<span class="params">name, param, callback</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> callbackId = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>();</span><br><span class="line">    _callbacks[callbackId] = callback;</span><br><span class="line">    <span class="keyword">var</span> invoke = &#123;</span><br><span class="line">        <span class="string">&quot;invokeName&quot;</span> : name,</span><br><span class="line">        <span class="string">&quot;callbackId&quot;</span> : callbackId</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">JavaProxy</span>.<span class="title function_">onTransact</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(invoke), <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(param));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> bridge.<span class="title function_">invoke</span>(<span class="string">&#x27;getPackageName&#x27;</span>, <span class="literal">null</span>, <span class="keyword">function</span>(<span class="params">packageName</span>)&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(packageName);</span><br><span class="line"> &#125;);  </span><br></pre></td></tr></table></figure>

<p>反之亦然。</p>
<h2 id="4-通信的数据格式是怎样的"><a href="#4-通信的数据格式是怎样的" class="headerlink" title="4. 通信的数据格式是怎样的"></a>4. 通信的数据格式是怎样的</h2><p>问题都处理了，只需要设计对应的协议即可。<br>按照上面的讨论,</p>
<p>在 client 端，我们使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Proxy.transact(invoke, callback);</span><br></pre></td></tr></table></figure>

<p>来调用 server 端注册的方法。</p>
<p>在 server 端，我们使用： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stub.register(name, handler);</span><br></pre></td></tr></table></figure>

<p>来注册新功能，使用 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stub.onTransact(invoke, handler);</span><br></pre></td></tr></table></figure>

<p>来处理接收到的 client 端调用。</p>
<p>其中，invoke 包含所要执行的方法以及回调的信息，因此，invoke 的设计如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    _invoke_id : <span class="number">1234</span>,  </span><br><span class="line">    _invoke_name : <span class="string">&quot;xxx&quot;</span>,  </span><br><span class="line">    _callback_id : <span class="number">5678</span>,  </span><br><span class="line">    _callback_name : <span class="string">&quot;xxx&quot;</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意 _invoke_id 与 _invoke_name 的区别：</p>
<pre><code>如果当前 invoke 是一个直接方法调用，那么 _invoke_id 应该是无效的。
如果当前 invoke 是一个回调，那么 _invoke_id + _invoke_name 共同决定回调的具体对象
</code></pre>
<h2 id="需要注意的问题"><a href="#需要注意的问题" class="headerlink" title="需要注意的问题"></a>需要注意的问题</h2><h4 id="1-回调函数需要及时删除，不然会引起内存泄漏。"><a href="#1-回调函数需要及时删除，不然会引起内存泄漏。" class="headerlink" title="1. 回调函数需要及时删除，不然会引起内存泄漏。"></a>1. 回调函数需要及时删除，不然会引起内存泄漏。</h4><p>由于我们使用一 Hash 来保存各自环境中的回调函数。如果某个回调由于某种原因没有被触发，那么，这个引用的对象就永远不会被回收。<br>针对这种问题，处理方案如下：</p>
<p>在 Java 环境中：</p>
<p>如果 WebView 被销毁了，应该手动移除所有的回调，然后禁用 javascript 。<br>另外，一个 WebView 可能加载多个 Html 页面，如果页面的 URL 发生了改变，这个时候也应该清理所有的回调，因为 Html 页面是无状态的，也不会传递相互数据。<br>这里有一点需要注意的是，如果 javascript 端是一个单页面应用，应该忽略 url 中 fragment （也就是 # 后面的部分） 的变化，因为并没有发生传统意义上的页面跳转，<br>所有单应用的 Page 之间是可能有交互的。</p>
<p>在 javascript 环境中：</p>
<p>javascript 端情况好很多，因为 WebView 会自己管理每个页面的资源回收问题。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p><a name="anchor_usage"></a></p>
<h3 id="必要配置"><a href="#必要配置" class="headerlink" title="必要配置"></a>必要配置</h3><p>请在对应的 html 页面中引入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js-bridge.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Java-环境"><a href="#Java-环境" class="headerlink" title="Java 环境"></a>Java 环境</h3><p>初始化 JsBridge:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jsBridge = <span class="keyword">new</span> <span class="title class_">JsBridge</span>(vWebView);</span><br></pre></td></tr></table></figure>

<p>加入 url 监控：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vWebView.setWebViewClient(<span class="keyword">new</span> <span class="title class_">WebViewClient</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageFinished</span><span class="params">(WebView view, String url)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPageFinished(view, url);</span><br><span class="line">        Log.e(<span class="string">&quot;onPageFinished&quot;</span>, url);</span><br><span class="line">        jsBridge.monitor(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Java 注册处理方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">jsBridge.register(<span class="keyword">new</span> <span class="title class_">SimpleServerHandler</span>(<span class="string">&quot;showPackageName&quot;</span>) &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String param, ServerCallback serverCallback)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> getPackageName();</span><br><span class="line">                Tip.showTip(getApplicationContext(), <span class="string">&quot;showPackageName:&quot;</span> + packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Java 在处理方法中回调 Javascript：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(<span class="keyword">final</span> String param, <span class="keyword">final</span> ServerCallback serverCallback)</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> getUser();</span><br><span class="line">            Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(param, Map.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> map.get(<span class="string">&quot;name_prefix&quot;</span>);</span><br><span class="line">            Tip.showTip(mContext, <span class="string">&quot;user.getName():&quot;</span> + prefix + <span class="string">&quot;/&quot;</span> + user.getName());</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;standard_error&quot;</span>.equals(prefix)) &#123;</span><br><span class="line">                Map&lt;String, String&gt; map1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                map1.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;get user failed&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">userMarshalling</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(map1);</span><br><span class="line">                serverCallback.invoke(<span class="string">&quot;fail&quot;</span>, <span class="keyword">new</span> <span class="title class_">MarshallableObject</span>(userMarshalling));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">userMarshalling</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>().toJson(user);</span><br><span class="line">                serverCallback.invoke(<span class="string">&quot;success&quot;</span>, <span class="keyword">new</span> <span class="title class_">MarshallableObject</span>(userMarshalling));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Java 执行 Js 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">jsBridge.invoke(<span class="string">&quot;jsFn4&quot;</span>, <span class="keyword">new</span> <span class="title class_">MarshallableString</span>(<span class="string">&quot;yellow&quot;</span>), <span class="keyword">new</span> <span class="title class_">ClientCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceiveResult</span><span class="params">(String invokeName, <span class="keyword">final</span> String invokeParam)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;success&quot;</span>.equals(invokeName)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Handler</span>(Looper.getMainLooper()).post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    Tip.showTip(getApplicationContext(), invokeParam);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getResult</span><span class="params">(String param)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> param;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>销毁 JsBridge</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    jsBridge.destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Javascript-环境"><a href="#Javascript-环境" class="headerlink" title="Javascript 环境"></a>Javascript 环境</h3><p>Javascript 的灵活性比较高，所以要简单一些：</p>
<p>Javascript 注册处理函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">JavaBridge</span>.<span class="title function_">serverRegister</span>(<span class="string">&#x27;jsFn4&#x27;</span>, <span class="keyword">function</span> (<span class="params">transactInfo, color</span>) &#123;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;jsFn4:&quot;</span> + color);</span><br><span class="line">    title.<span class="property">style</span>.<span class="property">background</span> = color;</span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;jsFn4:callback&quot;</span>);</span><br><span class="line">    transactInfo.<span class="title function_">triggerCallback</span>(<span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;background change to &#x27;</span> + color);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Javascript 执行 Java 方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> sdk = &#123;</span><br><span class="line">    <span class="attr">getUser</span>: <span class="keyword">function</span> (<span class="params">params</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> _invokeName = <span class="string">&#x27;getUser&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> _invokeParam = params;</span><br><span class="line">        <span class="keyword">var</span> _clientCallback = params;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">JavaBridge</span>.<span class="title function_">invoke</span>(_invokeName, _invokeParam, _clientCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">sdk.<span class="title function_">getUser</span>(&#123;</span><br><span class="line">    <span class="string">&quot;name_prefix&quot;</span>: <span class="string">&quot;standard_error&quot;</span>,</span><br><span class="line">    <span class="string">&quot;success&quot;</span>: <span class="keyword">function</span> (<span class="params">user</span>) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&#x27;sdk.getUser,success:&#x27;</span> + user.<span class="property">name</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;fail&quot;</span>: <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">        <span class="title function_">log</span>(<span class="string">&#x27;sdk.getUser,fail:&#x27;</span> + error.<span class="property">msg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>详细 Demo 请参见 <a target="_blank" rel="noopener" href="https://github.com/xesam/JsBridge">js-bridge-demo</a> 工程</p>

      </div>
      <div class="post-copyright">转载请标注原地址：<a href="https://xesam.github.io/2016/04/12/android/2016/2016-04-12-Android-how-to-JsBridge/">https://xesam.github.io/2016/04/12/android/2016/2016-04-12-Android-how-to-JsBridge/</a></div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2016/04/01/android/2016/2016-04-01-Android-Handler-2-Message/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>上一页</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="更新时间"></i>
              2025-04-16 16:32:33
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="分类"></i>
                    
                    <span class="span--category">
                      <a href="/categories/android/" title="android">
                        <b>#</b> android
                      </a>
                    </span>
                    
                  </span>
              
                  <span class="post-tags">
                    <i class="iconfont icon-tags mr-10" title="标签"></i>
                    
                    <span class="span--tag mr-8">
                      <a href="/tags/android/" title="android">
                        #android
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2016/04/24/android/2016/2016-04-24-Android-Handler-3-WeakHandler/" target="_self">
                <span>下一页</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">目录</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0"><span class="toc-text">原理概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-java-%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8-Javascript"><span class="toc-text">1. java 如何调用 Javascript</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Javascript-%E5%A6%82%E4%BD%95%E8%B0%83%E7%94%A8-java"><span class="toc-text">2. Javascript 如何调用 java</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0%E4%BB%A5%E5%8F%8A%E5%9B%9E%E8%B0%83%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86"><span class="toc-text">3. 方法参数以及回调如何处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E9%80%9A%E4%BF%A1%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84"><span class="toc-text">4. 通信的数据格式是怎样的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">需要注意的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E9%9C%80%E8%A6%81%E5%8F%8A%E6%97%B6%E5%88%A0%E9%99%A4%EF%BC%8C%E4%B8%8D%E7%84%B6%E4%BC%9A%E5%BC%95%E8%B5%B7%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E3%80%82"><span class="toc-text">1. 回调函数需要及时删除，不然会引起内存泄漏。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%85%E8%A6%81%E9%85%8D%E7%BD%AE"><span class="toc-text">必要配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E7%8E%AF%E5%A2%83"><span class="toc-text">Java 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Javascript-%E7%8E%AF%E5%A2%83"><span class="toc-text">Javascript 环境</span></a></li></ol></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        







      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/xesam">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
        <li>
          
            <a title="email" href="mailto:xesam@outlook.com">
              <i class="iconfont icon-envelope"></i>
            </a>
            
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a href="https://xesam.github.io/">Copyright © 2025</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://hexo.io">Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        


        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        

      </div>
    </div>
  </body>
</html>
